<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Octane - Oil TodayÂ®</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwUxEirWwl3V9ZyL9HS3CP-MPndbXmtp8&libraries=places,geometry"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 40px;
            background-color: #ffffff;
            min-height: 100vh;
            position: relative;
        }
    
        .nav {
            position: fixed;
            top: 40px;
            left: 40px;
        }
    
        .nav a {
            text-decoration: none;
            color: #000;
            font-size: 1.2rem;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        .nav a:hover {
            color: #FF4500;
        }
    
        .price-container {
            margin-top: 150px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
    
        .content-row {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
        }
    
        .chart-section {
            flex: 1;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-section {
            position: relative;
        }

        .chart-title {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1;  /* ê·¸ë˜í”„ ìœ„ì— í‘œì‹œ */
        }

        .chart-container {
            margin-top: 60px;  /* íƒ€ì´í‹€ì„ ìœ„í•œ ê³µê°„ í™•ë³´ */
            height: calc(100% - 60px);  /* ì „ì²´ ë†’ì´ì—ì„œ íƒ€ì´í‹€ ê³µê°„ ì œì™¸ */
        }
        .prediction-section {
            position: fixed;  /* ê³ ì • ìœ„ì¹˜ */
            top: 40px;       /* ìƒë‹¨ì—ì„œì˜ ê±°ë¦¬ */
            left: 50%;       /* ì™¼ìª½ì—ì„œ 50% */
            transform: translateX(-50%);  /* ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ ìì‹ ì˜ ë„ˆë¹„ì˜ ì ˆë°˜ë§Œí¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
            z-index: 1000;   /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œ */
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: auto;     /* ë‚´ìš©ì— ë§ê²Œ ë„ˆë¹„ ì¡°ì • */
            text-align: center;
        }
            
        .fuel-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 40px;
        }
    
        .price-recommendation {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
    
        .recommendation-text {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 2rem;
            text-align: center;
            padding: 30px;
        }
    
        .confidence-indicator {
            font-size: 1rem;
            margin-top: 8px;
            color: #666;
            font-weight: normal;
        }
    
        .chart-container {
            height: 400px;
        }
    
        /* í˜„ì¬ ìœ„ì¹˜ ê°€ê²© ì •ë³´ì˜ ìœ„ì¹˜ë„ ì¡°ì • */
        .current-location-price {
            position: fixed;
            top: 40px;
            right: 40px;
            z-index: 999;    /* prediction-sectionë³´ë‹¤ ë‚®ì€ z-index */
            width: 300px;
        }
    
        .location-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
    
        .current-price-card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        .map-and-stations {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto 40px;
        }
    
        .recommended-stations {
            flex: 1;
            margin: 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        .station-card {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
    
        .station-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
    
        .station-rank {
            font-size: 24px;
            font-weight: bold;
            margin-right: 20px;
            color: #FF4500;
        }
    
        .station-info {
            flex-grow: 1;
        }
    
        .station-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
    
        .station-details {
            font-size: 14px;
            color: #666;
        }
    
        .station-score {
            font-weight: bold;
            color: #FF4500;
        }
    
        .navi-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #FF4500;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
    
        .navi-button:hover {
            background-color: #FF5722;
        }
    
        .navi-button i {
            font-size: 16px;
        }
    
        .map-container {
            flex: 1;
            margin: 0;
        }
    
        .map-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
    
        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        .price-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* í•œ ì¤„ì— 4ê°œì”© */
            gap: 30px;  /* ê°„ê²© ì¦ê°€ */
            margin: 40px 0;  /* ìƒí•˜ ì—¬ë°± ì¶”ê°€ */
            padding: 20px;  /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
        }

        .price-card {
            background: #fff;
            border-radius: 15px;
            padding: 40px 30px;  /* ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
    
        .price-card:hover {
            transform: translateY(-5px);
        }
    
        .increase {
            color: #FF4500;
        }
    
        .decrease {
            color: #4169E1;
        }
    
        @media (max-width: 1024px) {
            .current-location-price {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 200px;
            }
    
            .current-price-card {
                padding: 15px;
            }
        }
    
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
    
            .nav {
                position: static;
                margin-bottom: 20px;
            }
    
            .content-row,
            .map-and-stations {
                flex-direction: column;
            }
    
            .chart-section,
            .prediction-section,
            .recommended-stations,
            .map-container {
                width: 100%;
            }
    
            .current-location-price {
                position: fixed;
                top: 10px;
                right: 10px;
                width: 150px;
                font-size: 0.9em;
            }
    
            .current-price-card {
                padding: 10px;
            }
    
            .location-title {
                font-size: 1rem;
            }
    
            .fuel-title {
                font-size: 2rem;
                margin-bottom: 20px;
            }
    
            .recommendation-text {
                font-size: 1.2rem;
                padding: 15px;
            }
    
            .chart-container {
                height: 250px;
            }
    
            .station-card {
                padding: 12px;
            }
    
            .station-name {
                font-size: 16px;
            }
    
            .station-details {
                font-size: 12px;
            }
    
            .navi-button {
                padding: 6px 12px;
                font-size: 12px;
            }
    
            .price-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
    
            .price-card {
                padding: 20px;
            }
    
            #map {
                height: 300px;
            }
        }
    
        @media (max-width: 480px) {
            .current-location-price {
                position: fixed;
                top: 10px;
                right: 10px;
                width: 120px;
            }
    
            .station-card {
                flex-direction: column;
                text-align: center;
            }
    
            .station-rank {
                margin-right: 0;
                margin-bottom: 10px;
            }
    
            .station-info {
                margin-bottom: 10px;
            }
    
            .navi-button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="../index.html">HOME</a>
    </nav>

    <div class="prediction-section">
        <div class="price-recommendation">
            <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
    </div>

    <div class="price-container">
        <div class="fuel-title">High Octane</div>
        
        <!-- ì§€ë„ì™€ ì¶”ì²œ ì£¼ìœ ì†Œ ì„¹ì…˜ -->
        <div class="map-and-stations">
            <div class="recommended-stations">
                <h2>ğŸ† ì¶”ì²œ ì£¼ìœ ì†Œ TOP 3</h2>
                <div id="stationList">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë‚´ìš© -->
                </div>
            </div>
            
            <div class="map-container">
                <div class="map-title">ì£¼ë³€ ì£¼ìœ ì†Œ ì°¾ê¸°</div>
                <div id="map"></div>
            </div>
        </div>

        <!-- ê·¸ë˜í”„ ì„¹ì…˜ -->
        <div class="chart-section">
            <h2 class="chart-title">ìµœê·¼ 7ì¼ê°„ ê°€ê²© ë³€ë™</h2>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- ê°€ê²© ê·¸ë¦¬ë“œ -->
        <div class="price-grid" id="priceGrid">
            <!-- ë°ì´í„°ëŠ” JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
        </div>
    </div>

    <div class="current-location-price">
        <div class="location-title">í˜„ì¬ ìœ„ì¹˜ ê°€ê²©</div>
        <div class="current-price-card">
            <div class="current-region">ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
            <div class="current-price">ê°€ê²© í™•ì¸ ì¤‘...</div>
            <div class="current-change">ë³€ë™ í™•ì¸ ì¤‘...</div>
        </div>
    </div>
</body>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let currentDirectionsRenderer = null;
        let currentInfoWindow = null;
    
        // ì£¼ìœ ì†Œ ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜
        function calculateStationScore(station, userLocation) {
            if (!station.rating) {
                return -1;
            }
    
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                userLocation,
                station.geometry.location
            );
            
            let w1;
            if (distance <= 500) w1 = 1.0;
            else if (distance <= 1000) w1 = 0.8;
            else if (distance <= 1500) w1 = 0.6;
            else if (distance <= 2000) w1 = 0.4;
            else if (distance <= 2500) w1 = 0.2;
            else if (distance <= 3000) w1 = 0.1;
            else w1 = 0.0;
    
            let w2;
            const rating = station.rating;
            if (rating >= 4.5) w2 = 1.0;
            else if (rating >= 4.0) w2 = 0.8;
            else if (rating >= 3.5) w2 = 0.5;
            else if (rating >= 3.0) w2 = 0.3;
            else w2 = 0.1;
    
            return (w1 * 0.7) + (w2 * 0.3);
        }
    
        function calculateConfidence(prices) {
            const recentTrends = [];
            for (let i = prices.length - 3; i < prices.length - 1; i++) {
                recentTrends.push(Math.sign(prices[i + 1] - prices[i]));
            }
            
            const trendConsistency = new Set(recentTrends).size === 1;
            const volatility = Math.sqrt(
                prices.slice(-3)
                    .map(x => Math.pow(x - prices[prices.length-1], 2))
                    .reduce((a, b) => a + b, 0) / 3
            );
            
            let confidence = trendConsistency ? 80 : 60;
            confidence -= (volatility > 10) ? 20 : 0;
            
            return Math.min(Math.max(confidence, 0), 100);
        }
    
        function predictNextDayPrice(prices) {
            const ma = prices.slice(-3).reduce((a, b) => a + b) / 3;
            const trend = prices[prices.length - 1] - prices[prices.length - 2];
            return ma + trend;
        }
    
        async function getCurrentLocationName(lat, lng) {
            const geocoder = new google.maps.Geocoder();
            const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
            
            try {
                const response = await new Promise((resolve, reject) => {
                    geocoder.geocode({ location: latlng }, (results, status) => {
                        if (status === "OK") {
                            resolve(results);
                        } else {
                            reject(status);
                        }
                    });
                });
    
                for (let component of response[0].address_components) {
                    if (component.types.includes('administrative_area_level_1')) {
                        let shortName = component.short_name
                            .replace('ê´‘ì—­ì‹œ', '')
                            .replace('íŠ¹ë³„ì‹œ', '')
                            .replace('íŠ¹ë³„ìì¹˜ì‹œ', '')
                            .replace('íŠ¹ë³„ìì¹˜ë„', '')
                            .replace('ë„', '');
                        return shortName;
                    }
                }
                return 'ì•Œ ìˆ˜ ì—†ìŒ';
            } catch (error) {
                console.error('Geocoding ì‹¤íŒ¨:', error);
                return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }
    
        async function updateCurrentLocationPrice(priceData, lat, lng) {
            try {
                const locationName = await getCurrentLocationName(lat, lng);
                const regionData = priceData[locationName];
                
                const currentPriceCard = document.querySelector('.current-price-card');
                if (regionData) {
                    currentPriceCard.innerHTML = `
                        <div class="current-region">${locationName}</div>
                        <div class="current-price">${regionData.price.toFixed(1)}ì›</div>
                        <div class="current-change ${regionData.diff >= 0 ? 'increase' : 'decrease'}">
                            ${regionData.diff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(regionData.diff).toFixed(1)}ì›
                        </div>
                    `;
                } else {
                    currentPriceCard.innerHTML = `
                        <div class="current-region">${locationName}</div>
                        <div class="current-price">ê°€ê²© ì •ë³´ ì—†ìŒ</div>
                        <div class="current-change">-</div>
                    `;
                }
            } catch (error) {
                console.error('í˜„ì¬ ìœ„ì¹˜ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }
        async function loadPriceData(position) {
        try {
            console.log('Fetching data...');
            const sidoResponse = await fetch('../api/data/oil_prices_sido.json');
            const sidoData = await sidoResponse.json();
            
            const historyResponse = await fetch('../api/data/oil_prices_7day.json');
            const historyData = await historyResponse.json();
            
            // í•˜ì´ì˜¥íƒ„ì˜ ì œí’ˆì½”ë“œ(B034)ë¡œ ë³€ê²½
            const dieselData = sidoData.filter(item => item.PRODCD === "B034");
            // "ê³ ê¸‰íœ˜ë°œìœ "ë¡œ ë³€ê²½
            const historicalPrices = historyData.historical_prices["ê³ ê¸‰íœ˜ë°œìœ "];
            
            const priceData = {};
            dieselData.forEach(item => {
                priceData[item.SIDONM] = {
                    price: parseFloat(item.PRICE),
                    diff: parseFloat(item.DIFF)
                };
            });

            if (position && position.coords) {
                await updateCurrentLocationPrice(priceData, position.coords.latitude, position.coords.longitude);
            }

            const mainRegions = ['ì „êµ­ í‰ê· ','ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ','ëŒ€ì „','ëŒ€êµ¬','ë¶€ì‚°','ìš¸ì‚°','ê´‘ì£¼','ì œì£¼'];
            const priceGrid = document.getElementById('priceGrid');
            priceGrid.innerHTML = '';

            const avgPrice = Object.values(priceData).reduce((sum, item) => sum + item.price, 0) / Object.keys(priceData).length;
            const avgDiff = Object.values(priceData).reduce((sum, item) => sum + item.diff, 0) / Object.keys(priceData).length;

            const predictedPrice = predictNextDayPrice(historicalPrices);
            const confidence = calculateConfidence(historicalPrices);

            // ì˜ˆì¸¡ ê²°ê³¼ í‘œì‹œ
            const priceRecommendation = document.querySelector('.price-recommendation');
            priceRecommendation.innerHTML = `
                <div class="recommendation-text ${predictedPrice > historicalPrices[historicalPrices.length-1] ? 'increase' : 'decrease'}">
                    ${predictedPrice > historicalPrices[historicalPrices.length-1] ? 
                        'ğŸ’¡ ì˜¤ëŠ˜ ì£¼ìœ í•´ì•¼í•´ìš©~' : 
                        'ğŸ’¡ ë‚´ì¼ ë„£ëŠ”ê²Œ ì¡°íƒ€ì‰~'}
                    <div class="confidence-indicator">
                        ì‹ ë¢°ë„: ${confidence}%
                    </div>
                </div>
            `;

            // ì°¨íŠ¸ ìƒì„±
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['7ì¼ì „', '6ì¼ì „', '5ì¼ì „', '4ì¼ì „', '3ì¼ì „', '2ì¼ì „', 'ì˜¤ëŠ˜', 'ë‚´ì¼'],
                    datasets: [{
                        label: 'ì‹¤ì œ ê°€ê²©',
                        data: historicalPrices,
                        borderColor: '#FF4500',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: '#FF4500'
                    },
                    {
                        label: 'ì˜ˆì¸¡ ê°€ê²©',
                        data: [...Array(historicalPrices.length-1).fill(null), 
                               historicalPrices[historicalPrices.length-1], 
                               predictedPrice],
                        borderColor: '#4169E1',
                        borderDash: [5, 5],
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: '#4169E1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            // ì§€ì—­ë³„ ê°€ê²© ê·¸ë¦¬ë“œ ìƒì„±
            mainRegions.forEach(region => {
                const price = region === 'ì „êµ­ í‰ê· ' ? avgPrice : priceData[region].price;
                const diff = region === 'ì „êµ­ í‰ê· ' ? avgDiff : priceData[region].diff;
                
                const card = document.createElement('div');
                card.className = 'price-card';
                card.innerHTML = `
                    <div class="region">${region}</div>
                    <div class="price">${price.toFixed(1)}ì›</div>
                    <div class="change ${diff >= 0 ? 'increase' : 'decrease'}">
                        ${diff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(diff).toFixed(1)}ì›
                    </div>
                `;
                priceGrid.appendChild(card);
            });

        } catch (error) {
            console.error('Error details:', error);
        }
    }

    function initMap(position) {
        const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };

        const map = new google.maps.Map(document.getElementById("map"), {
            center: pos,
            zoom: 15,
            styles: [
                {
                    featureType: "poi.business",
                    stylers: [{ visibility: "off" }],
                }
            ]
        });

        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
        new google.maps.Marker({
            position: pos,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: "#FF4500",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#FFFFFF",
            },
            title: "í˜„ì¬ ìœ„ì¹˜"
        });

        // ì£¼ë³€ ì£¼ìœ ì†Œ ê²€ìƒ‰
        const service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
            location: pos,
            radius: 3000,
            keyword: 'ì£¼ìœ ì†Œ'
        }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                const scoredStations = results
                    .filter(station => station.rating)
                    .map(station => ({
                        station: station,
                        score: calculateStationScore(station, new google.maps.LatLng(pos.lat, pos.lng))
                    }))
                    .filter(item => item.score > 0);

                const topStations = scoredStations
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);

                const stationList = document.getElementById('stationList');
                stationList.innerHTML = '';

                // ìƒìœ„ 3ê°œ ì£¼ìœ ì†Œ í‘œì‹œ
                topStations.forEach((item, index) => {
                    const station = item.station;
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(pos.lat, pos.lng),
                        station.geometry.location
                    );

                    const card = document.createElement('div');
                    card.className = 'station-card';
                    // ì£¼ìœ ì†Œ ì¹´ë“œ HTML ë¶€ë¶„ ìˆ˜ì •
                    card.innerHTML = `
                        <div class="station-info">
                            <div class="station-rank">${index + 1}</div>
                            <div class="station-content">
                                <div class="station-name">${station.name}</div>
                                <div class="station-details">
                                    <span class="station-score">ê±°ë¦¬: ${(distance/1000).toFixed(1)}km</span> | 
                                    â­ ${station.rating.toFixed(1)} 
                                    (${station.user_ratings_total}ê°œì˜ í‰ê°€)
                                </div>
                            </div>
                        </div>
                        <button class="navi-button">
                            <i class="fas fa-route"></i>
                            ê²½ë¡œì•ˆë‚´
                        </button>
                    `;

                    // ê²½ë¡œì•ˆë‚´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    const naviButton = card.querySelector('.navi-button');
                    // ê²½ë¡œì•ˆë‚´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    // ê²½ë¡œì•ˆë‚´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    naviButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        // ì¢Œí‘œë¥¼ ì†Œìˆ˜ì  6ìë¦¬ê¹Œì§€ë§Œ ì œí•œ
                        const startLat = parseFloat(pos.lat).toFixed(6);
                        const startLng = parseFloat(pos.lng).toFixed(6);
                        const endLat = parseFloat(station.geometry.location.lat()).toFixed(6);
                        const endLng = parseFloat(station.geometry.location.lng()).toFixed(6);

                        // ë„¤ì´ë²„ ëª¨ë°”ì¼ ì§€ë„ URL ì‚¬ìš©
                        // ëª¨ë°”ì¼ ê¸°ê¸° ì²´í¬ (ë§¥ë¶ ì œì™¸)
                        // ëª¨ë°”ì¼ ê¸°ê¸° ì²´í¬ (ë§¥ë¶ ì œì™¸)
                        // ë””ë°”ì´ìŠ¤ ì²´í¬ ë¡œì§ ìˆ˜ì •
                        // ë””ë°”ì´ìŠ¤ ì²´í¬ ë¡œì§ ìˆ˜ì • (M1 ë§¥ë¶ í¬í•¨)
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                        const isApple = /Macintosh|MacIntel|MacPPC|Mac68K/i.test(navigator.userAgent);
                        const isM1 = /arm/i.test(navigator.userAgent);

                        if (isMobile && !isApple && !isM1) {
                            // ìˆœìˆ˜ ëª¨ë°”ì¼ ê¸°ê¸°ìš© URL
                            naverUrl = `nmap://route/car?slat=${startLat}&slng=${startLng}&sname=í˜„ì¬ìœ„ì¹˜&dlat=${endLat}&dlng=${endLng}&dname=${encodeURIComponent(station.name)}&appname=com.example.myapp`;
                        } else {
                            // PC ë° ë§¥ë¶ìš© URL (ìƒˆë¡œìš´ ë„¤ì´ë²„ ì§€ë„ í˜•ì‹)
                            const startCoord = `${startLng},${startLat}`;  // ê²½ë„,ìœ„ë„ ìˆœì„œ
                            const endCoord = `${station.geometry.location.lng()},${station.geometry.location.lat()}`;
                            
                            naverUrl = `https://map.naver.com/p/directions/${startCoord},í˜„ì¬ìœ„ì¹˜,,,/${endCoord},${encodeURIComponent(station.name)},,/-/car?c=${startCoord},13`;
                        }
                        
                        window.open(naverUrl, '_blank');
                    });

                    // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
                    card.addEventListener('click', () => {
                        const stationLocation = station.geometry.location;
                        const bounds = new google.maps.LatLngBounds();
                        bounds.extend(pos);
                        bounds.extend(stationLocation);
                        map.fitBounds(bounds);
                    });

                    stationList.appendChild(card);
                });

                // ëª¨ë“  ì£¼ìœ ì†Œ ë§ˆì»¤ í‘œì‹œ
                results.forEach(place => {
                    const marker = new google.maps.Marker({
                        map: map,
                        position: place.geometry.location,
                        icon: {
                            url: "https://maps.google.com/mapfiles/ms/icons/gas.png",
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });

                    marker.addListener("click", () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }

                        service.getDetails(
                            {
                                placeId: place.place_id,
                                fields: ["name", "formatted_address", "rating", "user_ratings_total", "opening_hours", "formatted_phone_number"]
                            },
                            (placeDetails, status) => {
                                if (status === google.maps.places.PlacesServiceStatus.OK) {
                                    const infoWindow = new google.maps.InfoWindow();
                                    currentInfoWindow = infoWindow;

                                    infoWindow.setContent(`
                                        <div class="info-window">
                                            <h3>${placeDetails.name}</h3>
                                            <p>ğŸ¢ ${placeDetails.formatted_address}</p>
                                            ${placeDetails.formatted_phone_number ? 
                                                `<p>ğŸ“ ${placeDetails.formatted_phone_number}</p>` : ''}
                                            ${placeDetails.rating ? 
                                                `<p>â­ï¸ ${placeDetails.rating} (${placeDetails.user_ratings_total}ê°œì˜ í‰ê°€)</p>` : ''}
                                            ${placeDetails.opening_hours?.isOpen() ? 
                                                '<p style="color: green;">âœ… ì˜ì—…ì¤‘</p>' : 
                                                '<p style="color: red;">âŒ ì˜ì—…ì¢…ë£Œ</p>'}
                                        </div>
                                    `);
                                    infoWindow.open(map, marker);
                                }
                            }
                        );
                    });
                });
            }
        });

        loadPriceData(position);
    }

    function handleLocationError(error) {
        console.log("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", error);
        initMap({ coords: { latitude: 36.3504119, longitude: 127.3845475 } });
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(initMap, handleLocationError);
    } else {
        console.log("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
</script>

